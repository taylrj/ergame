var x$,ref$=[1170,658],w=ref$[0],h=ref$[1],patw=(ref$=[193,278])[0],path=ref$[1],of1x=(ref$=[298,273])[0],of1y=ref$[1],dpw=(ref$=[59,20])[0],dph=ref$[1];(x$=angular.module("ERGame",[])).controller("ERGame",["$scope","$interval","$timeout"].concat(function(u,i,a){for(var n,r,o,s,d,t=[],e=0;e<12;++e)n=e,t.push([n%4,parseInt(n/4)]);return u.list=t,u.pixel={scene:{w:1170,h:658},sprite:{size:[{w:0,h:0},{w:101,h:142},{w:108,h:229},{w:108,h:229},{w:291,h:245},{w:316,h:269},{w:105,h:196},{w:146,h:239},{w:98,h:60},{w:306,h:298},{w:191,h:240},{w:104,h:136},{w:238,h:184}],points:[{x:591,y:-19,type:6}].concat([{x:317,y:-3,type:5}],[{x:687,y:-36,type:7}],[{x:503,y:65,type:8}],[{x:507,y:54,type:9,variant:1}],[{x:249,y:184,type:11}],function(){for(var t,e=[],n=0;n<3;++n)for(r=n,t=0;t<4;++t)o=t,e.push({x:293+59*o+-127*r,y:222+20*o+47*r,type:1,variant:0,active:1});return e}(),[{x:857,y:100,type:4,variant:0,active:1}],[{x:870,y:272,type:12}],function(){for(var t=[],e=0;e<5;++e)n=e,t.push({x:749+66*n,y:227+24*n,type:2,variant:0,active:1});return t}(),[{x:623,y:279,type:3,variant:0,active:1},{x:520,y:341,type:10},{x:730,y:387,type:4,variant:0,active:1},{x:335,y:387,type:4,variant:0,active:1},{x:493,y:418,type:3,variant:0,active:1},{x:678,y:418,type:2,variant:0,active:1}])}},u.percent={sprite:{size:function(){for(var t,e=[],n=0,r=(t=u.pixel.sprite.size).length;n<r;++n)s=t[n],e.push({w:100*s.w/u.pixel.scene.w,h:100*s.h/u.pixel.scene.h});return e}(),points:function(){for(var t,e=[],n=0,r=(t=u.pixel.sprite.points).length;n<r;++n)s=t[n],e.push({x:100*s.x/u.pixel.scene.w,y:100*s.y/u.pixel.scene.h,type:s.type,variant:s.variant,active:s.active});return e}()}},u.rebuild=function(t){for(var e,n=[],r=0,i=(e=u.percent.sprite.points).length;r<i;++r)t=e[r],n.push(t.cls=(t.active?["active"]:[]).concat(["it-"+t.type+"-"+(t.variant||0)+"-"+(t.active||0)]));return n},u.game={state:0,setState:function(t){return this.state=t},start:function(){return this.setState(5),this.countdown.start()},reset:function(){return u.patient.reset(),u.doctor.reset(),u.supply.reset(),u.mouse.reset(),u.rebuild(),u.madmax=0,u.dialog.toggle(null,!1),this.state=0},countdown:{handler:null,value:0,count:function(){var t=this;return this.value=this.value-1,this.value?a(function(){return t.count()},650):u.game.setState(2)},start:function(){return this.value=5,this.count()}}},u.doctor={sprite:u.percent.sprite.points.filter(function(t){return 9===t.type})[0],handler:null,energy:1,faint:!1,chance:5,hurting:0,fail:function(){var t=this;if(t.setMood(7),--t.chance,0<=t.chance||(t.chance=0),t.hurting=1,this.chance<=0)return u.game.setState(4)},reset:function(){return this.energy=1,this.faint=!1,this.chance=5,this.hurting=0,this.handler&&a.cancel(this.handler),this.setMood(1)},score:{digit:[0,0,0,0],value:0},resetLater:function(){var t=this;return this.handler&&a.cancel(this.handler),this.handler=a(function(){return t.setMood(1),t.handler=null,u.rebuild()},1e3)},setMood:function(t){if(1<(this.sprite.variant=t))return this.resetLater()}},u.$watch("doctor.score.value",function(){for(var t,e=[],n=u.doctor.score,r=0;r<4;++r)t=r,e.push(n.digit[3-t]=parseInt(n.value/Math.pow(10,t))%Math.pow(10,t+1));return e}),u.supply={sprite:u.percent.sprite.points.filter(function(t){return 5===(t=t.type)||6===t||7===t||8===t}),reset:function(){for(var t,e,n=[],r=0,i=(t=this.sprite).length;r<i;++r)e=t[r],n.push((e.active=0,e.countdown=-1,e));return n},active:function(t,e){return null==e&&(e=!0),t=null==t?parseInt(Math.random()*this.sprite.length):t,e?(this.sprite[t].active=1,this.sprite[t].countdown=1):(this.sprite[t].active=0,t=(e=this.sprite[t]).countdown,delete e.countdown,t)}},u.patient={lvprob:[[.6,.9],[.4,.8],[.3,.3]],reset:function(){for(var t,e=[],n=u.percent.sprite.points.filter(function(t){return 1<=t.type&&t.type<=4}),r=0,i=n.length;r<i;++r)t=n[r],e.push((t.variant=0,t.mad=0,t.life=1,t));return e},add:function(e,t,n){var r,i,a=u.percent.sprite.points.filter(function(t){return t.type===e&&0===t.variant});if(0!==a.length)return r=parseInt(3*Math.random()+1),r=1===e?(i=Math.random())<this.lvprob[0][0]?1:i<this.lvprob[0][1]?2:3:parseInt(2*Math.random()+1),1<e&&(r<=2||(r=2)),null!=t&&(r=t),(i=a[null!=n?n:parseInt(Math.random()*a.length)]).variant=r,1===i.type&&(i.life=1),2!==(t=i.type)&&3!==t&&4!==t||(i.mad=0),u.rebuild()}},u.mouse={x:0,y:0,target:null,reset:function(){return this.target=null},lock:function(){return this.isLocked=!0},unlock:function(){return this.isLocked=!1},down:function(t,e){var n,r,i,a,o,s,c;if(!d()&&!(this.isLocked||u.madmax||u.doctor.faint)&&(n=$("#wrapper").offset(),t=[t.clientX-n.left,t.clientY-n.top],this.x=t[0],this.y=t[1],e=u.hitmask.resolve(n=t[0],r=t[1]))){if(1===e.type){if(0===e.variant)return;for(o=a=0,s=(i=u.percent.sprite.points.filter(function(t){return 1===t.type})).length;o<s;++o)(c=i[o]).variant>a&&(a=c.variant);if(3===a&&e.variant<a)return void(this.target=null)}if((this.target=e)&&1===e.type)return $("#wheel").css({display:"block",top:r+"px",left:n+"px"}),u.rebuild()}},up:function(i){var a=this;if(!d()&&!(this.isLocked||u.madmax||u.doctor.faint))return setTimeout(function(){var t,e,n,r;return $("#wheel").css({display:"none"}),t=$("#wrapper").offset(),e=(t=[i.clientX-a.x-t.left,i.clientY-a.y-t.top])[0],r=t[1],e=360*Math.acos(e/Math.sqrt(Math.pow(e,2)+Math.pow(r,2)))/(2*Math.PI),(320<=(e=0<r?360-e:e)||e<=10)&&(n=3),10<e&&e<=61&&(n=2),61<e&&e<112&&(n=1),a.target&&(1===a.target.type?(a.target.variant===n?1===a.target.variant?(r=Math.random()<.5?2:4+parseInt(3*Math.random()),null!=a.forceMood&&(r=a.forceMood),u.doctor.setMood(r),2===r&&(u.doctor.score.value+=1)):(null==a.forceStay&&.5<Math.random()?(u.doctor.setMood(3),u.patient.add(parseInt(3*Math.random()+2))):a.forceStay?(u.doctor.setMood(3),u.patient.add(4,2,0)):u.doctor.setMood(2),u.doctor.score.value+=1):u.doctor.fail(),a.target.variant=0,u.rebuild()):2<=a.target.type&&a.target.type<=4?(.8<a.target.mad&&(a.target.mad=.8),(t=a.target).mad<=.8||(t.mad=.8),a.target.mad-=.2,0<=(t=a.target).mad||(t.mad=0)):5<=a.target.type&&a.target.type<=8&&a.target.active&&(u.doctor.energy+=.1,(t=u.doctor).energy<=1||(t.energy=1),u.doctor.setMood(2),u.rebuild(),a.target.active=0,a.target.countdown=1)),a.target=null},0)}},u.madmax=0,u.demad=function(t){var e,n=u.percent.sprite.points.filter(function(t){return null!=t.mad&&1<=t.mad});return n.length||(u.madmax=0),n.length?((e=n[0]).mad<=.8||(e.mad=.8),n[0].mad-=.1,0<=(e=n[0]).mad||(e.mad=0)):u.doctor.faint&&((n=u.doctor).energy+=.1,n.energy<=1||(n.energy=1),1===u.doctor.energy&&(u.doctor.faint=!1)),t.preventDefault(),!1},u.rebuild(),d=function(){return 2!==u.game.state&&3!==u.game.state||!0===u.dialog.show},i(function(){if(!d()&&!u.dialog.tut)return Math.random()<.1&&u.patient.add(1),Math.random()<.1?u.supply.active():void 0},100),u.madspeed=.002,i(function(t){var e,n,r,i,a,o=[];if(!d()){for(u.doctor.hurting&&(u.doctor.hurting-=.2,0<=(e=u.doctor).hurting||(e.hurting=0)),r=0,i=(n=u.percent.sprite.points.filter(function(t){return 1===t.type&&0<t.variant})).length;r<i;++r)(t=n[r]).life-=.004*t.variant,t.life<=0&&(t.life=0,u.doctor.fail(),t.variant=0);for(r=a=0,i=(n=u.percent.sprite.points.filter(function(t){var e;return(2===(e=t.type)||3===e||4===e)&&0<t.variant})).length;r<i;++r)null==(t=n[r]).mad&&(t.mad=0),t.mad+=u.madspeed,.8<=t.mad&&(a=t.mad=1);if(a&&!u.madmax&&(u.madmax=parseInt(2*Math.random()+1)),!u.doctor.faint){for(r=0,i=(n=u.percent.sprite.points.filter(function(t){var e;return(5===(e=t.type)||6===e||7===e||8===e)&&t.active})).length;r<i;++r)(null==(t=n[r]).countdown||t.countdown<=0)&&(t.countdown=1),t.countdown-=.025,t.countdown<=0&&(t.countdown=1,t.active=0,u.doctor.energy-=.2,0<=(e=u.doctor).energy||(e.energy=0),0===u.doctor.energy&&o.push(u.doctor.faint=!0));return o}}},100),u.$watch("madmax",function(t){if(t)return $("#wheel").css({display:"none"})}),u.hitmask={ready:!1,get:function(t,e){return this.ready?this.ctx.getImageData(t,e,1,1).data:[0,0,0,0]},resolve:function(t,e){var t=this.get(t,e),n=t[0];return 0===n?null:(e=1===n?4*t[1]+t[2]:t[2],u.percent.sprite.points.filter(function(t){return t.type===n})[e])},init:function(){var t=this,e=this.canvas=document.createElement("canvas");return e.height=576,e.width=1024,this.ctx=this.canvas.getContext("2d"),this.img=new Image,this.img.src="assets/img/mask.png",this.img.onload=function(){return t.ctx.drawImage(t.img,0,0,1024,576),t.ready=!0}}},u.hitmask.init(),u.dialog={tut:!0,show:!1,idx:0,next:function(){var t=this;return a(function(){return t.main(!0)},200)},type:"",h:{i:[],t:[]},skip:function(){for(var t,e,n=0,r=(t=this.h.i).length;n<r;++n)e=t[n],i.cancel(e);for(n=0,r=(t=this.h.t).length;n<r;++n)e=t[n],a.cancel(e);return this.idx=this.step.length-2,this.toggle(0,!0)},interval:function(t,e){t=i(t,e);return this.h.i.push(t),t},timeout:function(t,e){t=a(t,e);return this.h.t.push(t),t},clean:function(){var t;return delete u.mouse.forceStay,delete u.mouse.forceMood,u.dialog.tut=!1,u.mouse.unlock(),$("#score").removeClass("hint"),(t=u.doctor).chance=5,t.hurting=0,t.faint=!1,t.energy=1,t.setMood(2),u.game.setState(2)},step:[{},{ready:!1,check:function(){return this.ready||2!==u.game.state||(u.game.state=3,this.ready=!0),this.ready},fire:function(){return u.mouse.forceStay=!1,u.mouse.forceMood=1,u.mouse.lock(),u.dialog.timeout(function(){return u.patient.add(1,1,0)},1e3),u.dialog.timeout(function(){return u.patient.add(1,2,0)},2e3),u.dialog.timeout(function(){return u.patient.add(1,3,0)},3e3)}},{ready:!1,check:function(){var t=this;return!!this.ready||(0<u.percent.sprite.points.filter(function(t){return 1===t.type&&3===t.variant}).length&&u.dialog.timeout(function(){return t.ready=!0},1e3),!1)}},{check:function(){return!0}},{check:function(){return!0},fire:function(){return $("#finger-slide").css({display:"block",top:"33%",left:"22%"}),setTimeout(function(){return $("#finger-slide").css({display:"none"}),u.mouse.unlock()},3e3)}},{check:function(){var t=this,e=0===u.percent.sprite.points.filter(function(t){return 1===t.type&&0!==t.variant}).length;return e&&(u.dialog.type="mini",this.handler=u.dialog.timeout(function(){return u.doctor.fail(),t.handler=null},500)),e},fire:function(){var t=u.doctor;if(t.chance=5,t.hurting=0,this.handler)return a.cancel(this.handler)}},{check:function(){return $("#score").addClass("hint"),!0},fire:function(){return $("#score").removeClass("hint")}},{mood:0,check:function(){var t=this;return null==this.handler&&(this.handler=u.dialog.interval(function(){return u.doctor.setMood(t.mood+4),u.rebuild(),t.mood=(t.mood+1)%3},500)),!0},fire:function(){return u.doctor.setMood(1),u.rebuild(),i.cancel(this.handler),u.mouse.forceStay=!0,u.patient.add(1,2,0)}},{mood:3,ready:!1,handler:null,moodHandler:null,check:function(){var t=this,e=0<u.percent.sprite.points.filter(function(t){return 4===t.type&&0<t.variant}).length,n=0<u.percent.sprite.points.filter(function(t){return 1===t.type&&2===t.variant}).length;return e&&null==this.handler&&(this.handler=u.dialog.timeout(function(){return t.ready=!0},1e3)),e||n||u.patient.add(1,2,parseInt(1+4*Math.random())),this.ready&&!this.moodHandler&&(this.moodHandler=u.dialog.interval(function(){return u.doctor.setMood(t.mood),u.rebuild(),t.mood=4-t.mood},500)),this.ready},fire:function(){return i.cancel(this.moodHandler),$("#finger-tap").css({display:"block",top:"22%",left:"68%"}),u.madspeed=.02,u.dialog.timeout(function(){return $("#finger-tap").css({display:"none"})},1300)}},{ready:!1,handler:null,check:function(){var t=this;return.02!==u.madspeed||"none"!==$("#finger-tap").css("display")||this.handler||(this.handler=u.dialog.timeout(function(){return t.ready=!0},2e3)),this.ready},fire:function(){return u.mouse.lock()}},{launched:0,supply:0,ready:!1,check:function(){var t=this;return 1<=u.madmax&&0===this.launched&&(this.launched=1,$("#finger-tap").css({display:"block",top:"30%",left:"30%"}),u.madspeed=.002,u.dialog.timeout(function(){return $("#finger-tap").css({display:"none"})},1e3)),.002===u.madspeed&&u.madmax<1&&1===this.launched&&(this.launched=2,u.percent.sprite.points.filter(function(t){return 4===t.type})[0].mad=0,u.dialog.timeout(function(){return t.handler=u.dialog.interval(function(){return u.supply.active(t.supply,!1),t.supply=(t.supply+1)%4,u.supply.active(t.supply)},500),$("#arrow").css({display:"block",top:"25%",left:"35%"}),t.ready=!0},1e3)),this.ready},fire:function(){return i.cancel(this.handler),u.supply.active(0,!1),u.supply.active(1,!0),u.supply.active(2,!1),u.supply.active(3,!1),$("#arrow").css({display:"none"}),$("#finger-tap").css({display:"block",top:"7%",left:"20%"}),u.dialog.timeout(function(){return $("#finger-tap").css({display:"none"})},1e3)}},{ready:!1,handler:!1,check:function(){var t=this;return this.handler||(this.handler=u.dialog.timeout(function(){return t.ready=!0,u.supply.active(1,!1),u.doctor.setMood(7),u.rebuild(),u.doctor.energy-=.1,$("#arrow").css({display:"block",top:"10%",left:"31%"})},3e3)),this.ready},fire:function(){return $("#arrow").css({display:"none"}),u.doctor.energy=0,u.doctor.faint=!0,$("#finger-tap").css({display:"block",top:"20%",left:"30%"}),u.dialog.timeout(function(){return $("#finger-tap").css({display:"none"})},1e3)}},{ready:!1,check:function(){var t=this;return console.log("hit"),null==this.handler&&1===u.doctor.energy&&!1===u.doctor.faint&&(this.handler=u.dialog.timeout(function(){return t.ready=!0,u.dialog.type=""},1e3)),this.ready},fire:function(){return u.dialog.clean()}},{check:function(){return!1}}],main:function(t){if((t=null==t?!1:t)&&this.step[this.idx]&&this.step[this.idx].fire&&!this.step[this.idx].fired&&(this.step[this.idx].fire(),this.step[this.idx].fired=!0),!this.show||t)return this.step[this.idx+1]&&this.step[this.idx+1].check()?this.toggle(this.idx+1,!0):this.toggle(0,!1)},toggle:function(t,e){var n=this;return t&&(this.idx=t),setTimeout(function(){return n.show=null==e?!n.show:e,n.show?$("#dialog").fadeIn():$("#dialog").fadeOut()},0)}},i(function(){return u.dialog.main()},100)}));